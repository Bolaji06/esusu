generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String          @id @default(uuid())
  fullName       String
  phone          String          @unique
  isAdmin        Boolean         @default(false)
  createdAt      DateTime        @default(now())
  address        String?
  email          String?
  occupation     String?
  password       String
  status         UserStatus      @default(ACTIVE)
  updatedAt      DateTime        @updatedAt
  pick           NumberPick?
  optOutRequests OptOutRequest[]
  participations Participation[]
  payments       Payment[]
  payouts        Payout[]
}

model BankDetails {
  id              String        @id @default(uuid())
  participationId String        @unique
  bankName        String
  accountNumber   String
  accountName     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  participation   Participation @relation(fields: [participationId], references: [id], onDelete: Cascade)
}

model ContributionCycle {
  id                     String          @id @default(uuid())
  name                   String
  startDate              DateTime
  endDate                DateTime
  registrationDeadline   DateTime
  numberPickingStartDate DateTime?
  status                 CycleStatus     @default(UPCOMING)
  paymentDeadlineDay     Int             @default(29)
  totalSlots             Int             @default(20)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  participations         Participation[]
  payments               Payment[]
  payouts                Payout[]
}

model Participation {
  id               String            @id @default(uuid())
  userId           String
  cycleId          String
  contributionMode ContributionMode
  pickedNumber     Int?
  monthlyAmount    Int
  totalPayout      Int
  fineAmount       Int
  registeredAt     DateTime          @default(now())
  hasOptedOut      Boolean           @default(false)
  bankDetails      BankDetails?
  cycle            ContributionCycle @relation(fields: [cycleId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  payments         Payment[]
  payout           Payout?

  @@unique([userId, cycleId])
  @@unique([cycleId, pickedNumber])
  @@index([cycleId, pickedNumber])
}

model Payment {
  id              String            @id @default(uuid())
  participationId String
  userId          String
  cycleId         String
  monthNumber     Int
  dueDate         DateTime
  amount          Int
  paidAt          DateTime?
  paidAmount      Int?
  status          PaymentStatus     @default(PENDING)
  hasFine         Boolean           @default(false)
  fineAmount      Int               @default(0)
  finePaid        Boolean           @default(false)
  proofOfPayment  String?
  verifiedBy      String?
  verifiedAt      DateTime?
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  cycle           ContributionCycle @relation(fields: [cycleId], references: [id])
  participation   Participation     @relation(fields: [participationId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id])

  @@unique([participationId, monthNumber])
  @@index([status, dueDate])
}

model Payout {
  id                String            @id @default(uuid())
  participationId   String            @unique
  userId            String
  cycleId           String
  amount            Int
  scheduledMonth    Int
  scheduledDate     DateTime
  paidAt            DateTime?
  status            PaymentStatus     @default(PENDING)
  transferReference String?
  processedBy       String?
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  cycle             ContributionCycle @relation(fields: [cycleId], references: [id])
  participation     Participation     @relation(fields: [participationId], references: [id], onDelete: Cascade)
  user              User              @relation(fields: [userId], references: [id])

  @@index([status, scheduledDate])
}

model OptOutRequest {
  id            String       @id @default(uuid())
  userId        String
  cycleId       String
  reason        String
  status        OptOutStatus @default(PENDING_APPROVAL)
  totalPaid     Int
  penaltyAmount Int          @default(0)
  refundAmount  Int          @default(0)
  requestedAt   DateTime     @default(now())
  reviewedAt    DateTime?
  reviewedBy    String?
  reviewNotes   String?
  user          User         @relation(fields: [userId], references: [id])

  @@index([status, requestedAt])
}

model SystemSettings {
  id                   String   @id @default(uuid())
  pack20kMonthly       Int      @default(20000)
  pack20kPayout        Int      @default(200000)
  pack20kFine          Int      @default(2000)
  pack50kMonthly       Int      @default(50000)
  pack50kPayout        Int      @default(500000)
  pack50kFine          Int      @default(2500)
  pack100kMonthly      Int      @default(100000)
  pack100kPayout       Int      @default(1000000)
  pack100kFine         Int      @default(5000)
  optOutPenaltyPercent Int      @default(10)
  updatedAt            DateTime @updatedAt
  updatedBy            String?
}

model NumberPick {
  id        String   @id @default(uuid())
  number    Int      @unique
  userId    String   @unique
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model NumberSettings {
  id           String   @id @default(uuid())
  totalNumbers Int      @default(20)
  isActive     Boolean  @default(true)
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

enum ContributionMode {
  PACK_20K
  PACK_50K
  PACK_100K
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  WAIVED
}

enum UserStatus {
  ACTIVE
  OPTED_OUT
  SUSPENDED
  COMPLETED
  DELETED
}

enum CycleStatus {
  UPCOMING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum OptOutStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}
